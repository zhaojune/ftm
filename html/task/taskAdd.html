

<div style="border-bottom: 1px solid #99BBE8;height: 2%;padding: 20px;">
    <span style="font-size: 20px;">任务添加</span>
</div>

<div>
    <table style="padding-top: 20px;padding-left:40px;font-size: 18px;height: 80%" cellspacing="0">
        <table style="padding-left: 50px;font-size: 15px;">
            <tr style="height: 50px;">
                <td>
                    <span >任务类型:</span>
                </td>
                <td style="padding-left: 50px;width: 49%;">
                    <input id="taskType_select" class="easyui-combobox" data-options="prompt:'请选择任务类型'" style="font-size: 15px;color:gainsboro;width:100%;height: 30px;"/>
                </td>
                <td id="irs_title" style="padding-left: 50px;">
                    <span>更新后是否重启终端:</span>
                </td>
                <td style="padding-left: 50px;">
                    <input type="radio" checked name="ifrs" value="0">否

                    <input style="padding-left: 30px;" type="radio" name="ifrs" value="1"/>是
                </td>
            </tr>
            </table>
        <table style="padding-left: 50px;font-size: 15px;">
            <tr style="height: 50px;">
                <td>
                    <span>任务名称:</span>
                </td>
                <td style="padding-left: 50px;width: 40%;">
                    <input class="easyui-textbox" id="taskName" data-options="prompt:'请输入任务名称'" style="font-size: 15px;color:gainsboro;width: 100%;height: 30px;"/>
                </td>
            </tr>
            <tr style="height: 50px;">
                <td>
                    <span>开始时间:</span>
                </td>
                <td style="padding-left: 50px;width: 40%;">
                    <input id="startTime" data-options="prompt:'任务开始时间'" editable="false" style="color:gainsboro;width:100%;height: 30px;" class="easyui-datetimebox"/>
                </td>
                <td style="padding-left: 50px;">
                    <span>结束时间:</span>
                </td>
                <td style="padding-left: 50px;width: 40%;">
                    <input id="endTime" data-options="prompt:'任务结束时间'" editable="false" style="color:gainsboro;width:100%;height: 30px;" class="easyui-datetimebox"/>
                </td>
            </tr>
        </table>

        <table style="padding-left: 50px;font-size: 15px;">
            <tr style="height: 50px;">
                <td>
                    <span>执行策略:</span>
                </td>
                <td style="padding-left: 50px;">
                    <input type="radio" checked name="strategy_radio" value="只执行一次">只执行一次
                </td>
                <td style="padding-left: 50px;">
                    <input type="radio" name="strategy_radio" value="每天执行一次"/>每天执行一次
                </td >
                <td style="padding-left: 50px;">
                    <input type="radio" name="strategy_radio" value="每周执行一次">每周执行一次
                </td>
                <td style="padding-left: 50px;">
                    <input type="radio" name="strategy_radio" value="每月执行一次"/>每月执行一次
                </td>
            </tr>
        </table>
        <table style="padding-left: 50px;font-size: 15px;">
            <tr style="height: 50px;">
                <td>
                    <span>更新文件:</span>
                </td>
                <td style="padding-left: 50px;width: 90%;position:relative;">
                    <!--<form id="upload-form" action=host+"/upload" method="post" enctype="multipart/form-data" >-->
                        <!--　　　　<input type="file" id="upload" name="upload" /> <br />-->
                        <!--　　　　<input type="submit" value="Upload" />-->
                        <!--　　</form>-->
                    <form id="updateFileInfo"  action=host+"/upload" method="post" enctype="multipart/form-data">
                    <input class="easyui-textbox" id="updateFile_input" editable="false" data-options="prompt:'请添加需要更新的文件'" style="font-size: 15px;color:gainsboro;width: 90%;height: 30px;"/>
                    <input type='button'  value='浏览' style="background-color:#FFF; border:1px solid #1a7bc9;height:30px; width:9%;" />
                    <input type="file" name="fileField" id="fileField"
                           style="position:absolute; top:10px; right: 0%; height:30px; filter:alpha(opacity:0);opacity: 0;background:black;width:10%;" onchange="$('#updateFile_input').textbox('setValue',this.value)"/>
                    </form>
                </td>
            </tr>
        </table>
        <table style="padding-left: 50px;font-size: 15px;">
            <tr style="height: 50px;">
                <td >
                    <span>更新终端:</span>
                </td>
                <td style="padding-left: 50px;width: 90%;position:relative;">
                    <input id="terminalupdate_select" searcher="selectTerminal" class="easyui-searchbox" editable="false" data-options="prompt:'请选择执行任务的终端'" style="font-size: 15px;color:gainsboro;width: 100%;height: 30px;"/>
                </td>
            </tr>
        </table>

    </table>

    <div align="center" style="padding-top: 20px;">
        <input type="button" id="ta_add" value="确定创建" style="border:none;font-size: 15px;background: #99BBE8;width: 150px;" onclick="uploadFile()"/>
        <input type="button" id="ta_addTask" value="确定并创建新任务" style="border:none;font-size:15px;background: #99BBE8;width: 150px;" disabled="disabled"/>
        <input type="button" id="ta_resst" value="重置" style="border:none;font-size: 15px;background: #99BBE8;width: 150px;" onclick="add_reset()"/>

        <input type="button" id="ta_back" value="返回" style="border:none;font-size: 15px;background: #99BBE8;width: 150px;" onclick="Back('任务修改')"/>
    </div>

    <div id="selectTerminalDialog"  class="easyui-dialog" title="" closed="true" style="width:90%;height:100%;padding:5px;"></div>


</div>

<script>
    $(function(){
        if(isUpdate){
            updateTask = currTask;
            $('#taskType_select').val(updateTask.Type);
            $('#taskName').val(updateTask.Name);
            $('#startTime').val(updateTask.StartTime);
            $('#endTime').val(updateTask.EndTime);

            let ra_no = -1;
            switch (updateTask.Strategy){
                case "0":
                    ra_no = 1;
                    break;
                case "D":
                    ra_no = 2;
                    break;
                case "W":
                    ra_no = 3;
                    break;
                case "M":
                    ra_no = 4;
                    break;
            }
            $("input[name='strategy_radio']").eq(ra_no).click();
            $('#updateFile_input').val(updateTask.FilePath);
        }

        $('#taskType_select').combobox({
            valueField:'id',
            textField:'text',
            value:-2,
            method:'get',
            url:'../json/task/taskType.json',
            editable:false
        });

    });

    function selectTerminal(){
        $('#selectTerminalDialog').dialog({
            title:"",
            href:'./terminal/terminalSelect.html'
        });
        $('#selectTerminalDialog').window('open');
    }

    function add_reset(){
        $('#taskType_select').combobox('setValue',"");
        $("input[name='ifrs']").eq(0).click();
        $('#taskName').textbox('setValue',"");
        $('#startTime').datetimebox('setValue',"");
        $('#endTime').datetimebox('setValue',"");
        $("input[name='strategy_radio']").eq(0).click();
        $('#updateFile_input').textbox('setValue',"");
        $('#terminalupdate_select').searchbox('setValue',"");
    }

    function addOrUpdate(reqTask) {

        console.log(reqTask);

        console.log(123);
        $.ajax({
            crossDomain: true,
            url: host+"/task",
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify(reqTask),
            success: function (res) {
                console.log(res);
                if (res.status_code === 100) {
                    if (isUpdate) {
                        alert("修改成功");
                    }
                    else {
                        alert("添加成功");
                    }
                }
                else {
                    alert("操作失败了");
                    console.log(res.status_Code);
                }
            },
            error: function (res) {
                console.log(res);
            }
        });
    }

    function uploadFile(){

        let id = null;
        if (isUpdate) {
            id = updateTask.ID;
        }

        let sty = "";
        switch ($("input[name='strategy_radio']:checked").val()) {
            case "只执行一次":
                sty = "O";
                break;
            case "每天执行一次":
                sty = "D";
                break;
            case "每周执行一次":
                sty = "W";
                break;
            case "每月执行一次":
                sty = "M";
                break;
        }

        let reqTask = {
            ID: id,
            Name: handleNullInfo($('#taskName').textbox('getValue')),
            Type: handleNullInfo($('#taskType_select').combobox('getValue')),
            StartTime: handleNullInfo($('#startTime').datetimebox('getValue')),
            EndTime: handleNullInfo($('#endTime').datetimebox('getValue')),
            Strategy: sty,
            NeedRestart: handleNullNum($("input[name='ifrs']:checked").val()),
            FilePath: handleNullInfo($('#updateFile_input').val()),
            Clients: selectTerminals
        };

        if(!reqTask.Name){
            alert("请输入姓名!");
            return;
        }
        if(!reqTask.StartTime){
            alert("请选择任务开始时间!");
            return;
        }
        if(!reqTask.EndTime){
            alert("请选择任务结束时间!");
            return;
        }
        if(selectTerminals.length === 0){
            alert("请选择终端!");
            return;
        }

        if(reqTask.StartTime&&reqTask.EndTime&&$('#startTime').datetimebox('getValue')>$('#endTime').datetimebox('getValue')){
            alert("开始时间大于结束时间");
            return;
        }

        jQuery.support.cors = true;
        let formData = new FormData();
        formData.append('file', $('#fileField')[0].files[0]);

        if(!$('#fileField')[0].files[0]){
            alert("请选择文件!");
            return;
        }
        console.log(formData);
        $.ajax({
            url: 'http://115.159.142.32:20002/upload',
            type: 'POST',
            cache: false,
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if(res.status_code === 100){
                    alert("文件上传成功");
                    addOrUpdate(reqTask);

                }
                else{
                    alert("文件上传失败");
                }
            },
            error: function (res) {
                console.log(res);
            }
        });
    }

</script>