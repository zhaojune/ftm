<div style="border-bottom: 1px solid #99BBE8;height: 2%;padding: 20px;">
    <span style="font-size: 20px;">任务进度</span>
</div>

<div>
    <table style="padding-top: 20px;padding-left:40px;font-size: 18px;height: 80%" cellspacing="0">
        <tr style="height: 50px;">
            <td>
                <span>任务类型:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleTaskType">下载SOK图片</span>
            </td>
            <td id="irs_title">
                <span>更新后是否重启终端:</span>
            </td>
            <td id="irs_content" style="padding-left: 50px;">
                <span id="scheduleIfRestart">否</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>任务名称:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleTaskName">更新SOK终端图片信息</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>开始时间:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleStartName">2017.8.1</span>
            </td>
            <td>
                <span>结束时间:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleEndTime">2017.9.1</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>执行策略:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleStrategy">只执行一次</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>更新文件:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleUpdateFile">文件名称1</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>任务进度:</span>
            </td>
            <td style="padding-left: 50px;">
                <div id="schedulePbar" class="easyui-progressbar" data-options="value:80,text:'已完成80%'" style="width:400px;"></div>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>完成终端:</span>
            </td>
        </tr>
    </table>

    <div class="easyui-tabs" id="resultTabs" style="width:100%;height: 3%;">
        <div title="已完成" >

        </div>
        <div title="未完成" >

        </div>
        <div title="更新失败" >

        </div>
    </div>


    <table id="schedule_list_data"   cellspacing="0" toolbar="#sch_tb" cellpadding="0" border="false" style="height:545px;width: 100%;" >
        <thead>
        <tr>
            <th field="terminalName" width="10%" align="center">终端名称</th>
            <th field="terminalNo" width="10%" align="center">终端编号</th>
            <th field="terminalType" width="10%" align="center">终端类型</th>
            <th field="stores" width="10%" align="center">所属门店</th>
            <th field="partionCompanies" width="10%" align="center">所属分公司</th>
            <th field="np6" width="10%" align="center">NP6</th>
            <th field="np6App" width="10%" align="center">NP6 APP</th>
            <th field="sokPic" width="10%" align="center">SOK图片</th>
            <th field="ownSoftware" width="10%" align="center">自有软件</th>
            <th field="keyPos" width="10%" align="center">键位</th>
            <th field="failLog" width="10%" align="center">失败说明</th>

        </tr>
        </thead>

    </table>
    <div id="sch_tb" style="padding-left:10px;padding-top:20px;padding-bottom:10px;font-size: 15px;">
        <div style="height: 50%;">
            <label style="padding-left:10px;width: 20%;">
                <input id="schedulePartionCompany_select" class="easyui-combobox" data-options="prompt:'选择分公司'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>
            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleStore_select" class="easyui-combobox" data-options="prompt:'选择门店'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>
            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalType_select" class="easyui-combobox" data-options="prompt:'选择终端类型'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalName_input" class="easyui-textbox" data-options="prompt:'输入终端名称'" style="border:1px solid #b7d2ff;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalNo_input" class="easyui-textbox" data-options="prompt:'输入终端编号'" style="border:1px solid #b7d2ff;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;">
                <a style="background: #99BBE8;height:35px;width: 100px;;color: black;" class="easyui-linkbutton" plain="true" onclick="sch_searchTerminal()">搜索</a>
            </label>

        </div>
    </div>



</div>
<div align="center" style="padding-top: 20px;">
    <input type="button" id="schedule_back" value="返回" style="border:none;font-size: 20px;background: #99BBE8;width: 150px;"onclick="Back('任务进度')"/>
</div>

<script>

    $('#schedule_list_data').datagrid({
            fitColumns:true,
            nowrap: false,
            striped: true,
            border: true,
            collapsible:false,//是否可折叠
            remoteSort:false,
            idField:'fldId',
            singleSelect:false,//是否单选
            pagination:true,//分页控件
            rownumbers:false//行号
        });
    var sld = $('#schedule_list_data').datagrid('getPager');
    $(sld).pagination({
            pageSize: 10,
            pageList: [5,10,15],
            beforePageText: '',
            afterPageText: '',
            displayMsg: '共 {total} 条记录'
        });

    $('#resultTabs').tabs({
            onSelect:function(title){
                if(title !== '更新失败'){
                    $("#schedule_list_data").datagrid('hideColumn', 'failLog');
                }
                else{
                    $("#schedule_list_data").datagrid('showColumn', 'failLog');
                }
            }
        });

    $('#scheduleTaskType').html(currTask.Type);
    $('#scheduleTaskName').html(currTask.Name);
    $('#scheduleStartName').html(currTask.StartTime);
    $('#scheduleEndTime').html(currTask.EndTime);

    let sty = "";
    switch (currTask.Strategy){
        case "O":
            sty="只执行一次";
            break;
        case "D":
            sty="每天执行一次";
            break;
        case "W":
            sty="每周执行一次";
            break;
        case "M":
            sty="每月执行一次";
            break;
    }
    $('#scheduleStrategy').html(sty);

    let fileNames = currTask.FilePath.split('/');
    $('#scheduleUpdateFile').html(fileNames[fileNames.length-1]);

    $("#schedulePartionCompany_select").combobox({
        onChange: function (n,o) {
            getsch_Stores();
        }
    });

    let selectTerminals = {};

    $(function () {
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/company",
            type: 'GET',
            contentType:"application/json",
            data: {
                partnerId:0
            },
            success: function (res) {
                if(res.statusCode === 100) {
                    //res = JSON.stringify(res);

                    let data = res.company;
                    console.log(data);
                    let companies = [];
                    for (let i in data) {
                        companies.push({"text": data[i].CompanyName, "value": data[i].CompanyCode});
                    }
                    console.log(JSON.stringify(companies));
                    $("#schedulePartionCompany_select").combobox('loadData', companies);
                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                console.log(res);
            }
        });


    });

    function getsch_Stores(){
        let companyId = $('#tsPartionCompany_select').combobox('getValue');
        console.log(companyId);
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/store",
            type: 'GET',
            contentType:"application/json",
            data: {
                companyCode:companyId
            },
            success: function (res) {
                console.log(res);
                if(res.statusCode === 100){
                    // res = JSON.stringify(res);
                    let data = res.stores;
                    let stores = [];
                    for(let i in data){
                        if(data[i].CompanyCode === companyId){
                            stores.push({ "text": data[i].StoreName, "id": data[i].StoreID });
                        }
                    }
                    $("#scheduleStore_select").combobox('loadData', stores);
                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                console.log(res);
            }
        });
    }

    function sch_searchTerminal(){

        let grid = $('#schedule_list_data');
        let options = grid.datagrid('getPager').data("pagination").options;

        let pageIndex = parseInt(options.pageNumber)-1;
        let pageSize = parseInt(options.pageSize);

        let componayCode = $('#schedulePartionCompany_select').combobox('getValue');
        let storeId = $('#scheduleStore_select').combobox('getValue');
        let posType = $('#scheduleTerminalType_select').combobox('getValue');

        let state = $('#resultTabs').tabs('getSelected').panel('options').title;

        let postName = $('#scheduleTerminalName_input').textbox('getValue');
        let posId = $('#scheduleTerminalNo_input').textbox('getValue');

        let reqDate = {
            pageIndex:pageIndex,
            pageSize:pageSize,
            companyCode:componayCode,
            storeId:storeId,
            posType:posType,
            state:state,
            postName:postName,
            posId:posId
        };

        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/pos",
            type: 'POST',
            contentType:"application/json",
            data: JSON.stringify(reqDate),
            success: function (res) {
                console.log(res);
                if(res.statusCode === 100){
                    let listData = res.data.rows;
                    let listDatas = new Array();
                    for ( let i=0;i<parseInt(res.data.total);i++) {
                        selectTerminals[ID] = listData[i];
                        let rowData =  {
                            //'terminalName' : listData[i].ID,
                            'terminalNo' : listData[i].PosID,
                            'terminalType':listData[i].Type,
                            //'partionCompanies' : listData[i].StartTime,
                            'stores' : listData[i].StoreName,
                            'np6' : listData[i].Np6Version,
                            'np6App' : listData[i].Np6ExeVersion,
                            'sokPic' : listData[i].SOKPicVer,//??
                            'ownSoftware' : listData[i].SelfSoft,
                            'keyPos' : listData[i].ForkVersion
                            //''
                        };
                        listDatas.push(rowData);
                    }
                    $('#schedule_list_data').datagrid('loadData',listDatas);

                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                console.log(res);
            }
        });
    }


</script>


