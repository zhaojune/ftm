<div style="border-bottom: 1px solid #99BBE8;height: 2%;padding: 20px;">
    <span style="font-size: 20px;">任务进度</span>
</div>

<div>
    <table style="padding-top: 20px;padding-left:40px;font-size: 18px;height: 80%" cellspacing="0">
        <tr style="height: 50px;">
            <td style="width: 100px;">
                <span>任务类型:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleTaskType"></span>
            </td>
            <td style="padding-left: 20px;">
                <span>更新后是否重启终端:</span>
            </td>
            <td id="ts_irs_content" style="padding-left: 50px;">
                <span id="scheduleIfRestart"></span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>任务名称:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleTaskName"></span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>开始时间:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleStartName"></span>
            </td>
            <td style="padding-left: 20px;">
                <span>结束时间:</span>
            </td>
            <td style="padding-left: 0px;">
                <span id="scheduleEndTime"></span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>执行策略:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleStrategy"></span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>更新文件:</span>
            </td>
            <td style="padding-left: 50px;">
                <span id="scheduleUpdateFile"></span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>任务进度:</span>
            </td>
            <td style="padding-left: 50px;">
                <div id="schedulePbar" class="easyui-progressbar" style="width:400px;"></div>
            </td>
        </tr>
        <tr style="height: 50px;">
            <td>
                <span>完成终端:</span>
            </td>
        </tr>
    </table>

    <div class="easyui-tabs" id="resultTabs" style="width:100%;height: 3%;">
        <!--<div title="已完成" onselect="true">-->

        <!--</div>-->
        <!--<div title="未完成" >-->

        <!--</div>-->
        <!--<div title="更新失败" >-->

        <!--</div>-->
    </div>


    <table id="schedule_list_data"   cellspacing="0" toolbar="#sch_tb" cellpadding="0" border="false" style="height:545px;width: 100%;" >
        <thead>
        <tr>
            <th field="terminalNo" width="11%" align="center">终端编号</th>
            <th field="terminalType" width="11%" align="center">终端类型</th>
            <th field="stores" width="11%" align="center">所属门店</th>
            <th field="partionCompanies" width="11%" align="center">所属分公司</th>
            <th field="np6" width="11%" align="center">NP6</th>
            <th field="np6App" width="13%" align="center">NP6 APP</th>
            <th field="sokPic" width="11%" align="center">SOK图片</th>
            <th field="ownSoftware" width="11%" align="center">自有软件</th>
            <th field="keyPos" width="11%" align="center">键位</th>
            <th field="failLog" width="11%" align="center">失败说明</th>

        </tr>
        </thead>

    </table>
    <div id="sch_tb" style="padding-left:10px;padding-top:20px;padding-bottom:10px;font-size: 15px;">
        <div style="height: 50%;">
            <label style="padding-left:10px;width: 20%;">
                <input id="schedulePartionCompany_select" editable="false" class="easyui-combobox" data-options="prompt:'选择分公司'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>
            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleStore_select"  editable="false" class="easyui-combobox" data-options="prompt:'选择门店'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>
            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalType_select" editable="false" class="easyui-combobox" data-options="prompt:'选择终端类型'" style="font-size: 15px;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalName_input" class="easyui-textbox" data-options="prompt:'输入终端名称'" editable="false" style="border:1px solid #b7d2ff;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;width: 20%;">
                <input id="scheduleTerminalNo_input" class="easyui-numberbox" data-options="prompt:'输入终端编号'" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" style="border:1px solid #b7d2ff;color:gainsboro;width: 150px;height: 30px;"/>
            </label>

            <label style="padding-left:10px;">
                <a style="background: #99BBE8;height:35px;width: 100px;;color: black;" class="easyui-linkbutton" plain="true" onclick="sch_searchTerminal()">搜索</a>
            </label>

        </div>
    </div>



</div>
<div align="center" style="padding-top: 20px;">
    <input type="button" id="schedule_back" value="返回" style="border:none;font-size: 20px;background: #99BBE8;width: 150px;"onclick="Back('任务进度')"/>
</div>

<script>




//    $('#scheduleTerminalType_select').combobox({
//        valueField:'text',
//        textField:'text',
//        url:'../json/terminal/terminalType.json',
//        editable:false
//    });

    $('#schedule_list_data').datagrid({
        fitColumns:true,
        nowrap: false,
        striped: true,
        border: true,
        collapsible:false,//是否可折叠
        remoteSort:false,
        idField:'fldId',
        singleSelect:false,//是否单选
        pagination:true,//分页控件
        rownumbers:false,//行号
        onClickRow:function(rowIndex, rowData){
            //取消选择某行后高亮
            $('#schedule_list_data').datagrid('unselectRow', rowIndex);
        }
    });
    var sld = $('#schedule_list_data').datagrid('getPager');
    $(sld).pagination({
        pageSize: 10,
        pageList: [5,10,15],
        beforePageText: '',
        afterPageText: ''
    });

    $("#schedulePartionCompany_select").combobox({
        onChange: function (n,o) {
            getsch_Stores();
        }
    });

    $(function () {

        jQuery.support.cors = true;
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/company",
            type: 'GET',
            contentType:"application/json",
            data: {
                partnerId:0
            },
            success: function (res) {
                if(res.status_code === 100) {
                    //res = JSON.stringify(res);

                    let data = res.company;
                    //console.log(data);
                    let companies = [{"text":"全选"}];
                    for (let i in data) {
                        companies.push({"text": data[i].CompanyName, "value": data[i].CompanyCode});
                    }
                    //console.log(JSON.stringify(companies));
                    $("#schedulePartionCompany_select").combobox('loadData', companies);
                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                //console.log(res);
            }
        });


        jQuery.support.cors = true;
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/taskinfo",
            type: 'GET',
            contentType: "application/json",
            data: {
                id: parseInt(currTaskID)
            },
            success: function (res) {
                //console.log(res);
                if (res.status_code === 100) {
                    let currTask = res.task;
                    $('#scheduleTaskType').html(currTask.type);
                    $('#scheduleTaskName').html(currTask.name);
                    $('#scheduleStartName').html(dateFormat(currTask.startTime));
                    $('#scheduleEndTime').html(dateFormat(currTask.endTime));
                    $('#scheduleIfRestart').html(currTask.needRestart==0?"否":"是");

                    let sty = "";
                    switch (currTask.strategy){
                        case "O":
                            sty="只执行一次";
                            break;
                        case "D":
                            sty="每天执行一次";
                            break;
                        case "W":
                            sty="每周执行一次";
                            break;
                        case "M":
                            sty="每月执行一次";
                            break;
                    }
                    $('#scheduleStrategy').html(sty);

                    let fn = currTask.filePath;
                    if(!fn ||fn === ""){
                        fn = "无";
                    }
                    else{
                        let fileNames = currTask.filePath.split('/');
                        fn = fileNames[fileNames.length-1];
                    }
                    $('#scheduleUpdateFile').html(fn);

                    let terminals = "";
                    for(let i in currTask.pos){
                        terminals+=currTask.pos[i].posName;
                        terminals+=",";
                    }
                    terminals = terminals.substr(0,terminals.length-1);

                    if(terminals === ""){
                        terminals = "无"
                    }
                    $('#scheduleUpdateTerminal').html(terminals);

                }
                else {
                    alert(res.msg);
                }
            },
            error: function (res) {
                //console.log(res);
            }
        });

        jQuery.support.cors = true;
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/taskschedule",
            type: 'GET',
            contentType: "application/json",
            dataType:"text",
            data: {
                id: parseInt(currTaskID),
                state:1
            },
            success:function (res) {

                console.log(res);
                console.log(parseFloat(res));

                let v = parseFloat(res)*100;

                if(v<0){
                    v=0;
                }

                $('#schedulePbar').progressbar({
                    value: v,
                    text: "已完成" + v + "%"
                });

            },
            error: function (res) {
                //console.log(res);
            }
        });

        jQuery.support.cors = true;
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/posattr",
            type: 'POST',
            contentType:"application/json",
            data: JSON.stringify({
                "attrs":["Type"]
            }),
            success: function (res) {

                if(res.status_code === 100){
                    let data = res.dic;
                    let types = [{"text":"全选"}];
                    for(let i in data.Type){
                        types.push({"text":data.Type[i].Attr});
                    }
                    $('#scheduleTerminalType_select').combobox({
                        valueField:'text',
                        textField:'text'
                    });
                    $('#scheduleTerminalType_select').combobox('loadData', types);

                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                //console.log(res);
            }
        });

    });

    function getsch_Stores(){
        let companyId = $('#schedulePartionCompany_select').combobox('getValue');
        //console.log(companyId);
        jQuery.support.cors = true;
        $.ajax({
            crossDomain: true,
            url: "http://115.159.142.32:20002/store",
            type: 'GET',
            contentType:"application/json",
            data: {
                companyCode:companyId
            },
            success: function (res) {
                //console.log(res);
                if(res.status_code === 100){
                    // res = JSON.stringify(res);
                    let data = res.stores;
                    let stores = [{"text":"全选"}];
                    for(let i in data){
                        if(data[i].CompanyCode === companyId){
                            stores.push({ "text": data[i].StoreName, "value": data[i].StoreID });
                        }
                    }
                    $("#scheduleStore_select").combobox('loadData', stores);
                    $('#scheduleStore_select').combobox('setValue',"全选");
                }
                else{
                    alert(res.msg);
                }
            },
            error: function (res) {
                //console.log(res);
            }
        });
    }

    let selectTerminals = {};

    function sch_searchTerminal(){

        let grid = $('#schedule_list_data');
        let options = grid.datagrid('getPager').data("pagination").options;

        let pageIndex = parseInt(options.pageNumber)-1;
        if(pageIndex === -1){
            pageIndex++;
        }
        let pageSize = parseInt(options.pageSize);

        let componayCode = handleNullInfo($('#schedulePartionCompany_select').combobox('getValue'));
        let storeId = handleNullInfo($('#scheduleStore_select').combobox('getValue'));
        let posType = handleNullInfo($('#scheduleTerminalType_select').combobox('getValue'));

        let state = handleNullInfo($('#resultTabs').tabs('getSelected').panel('options').title);
        let posId = handleNullNum($('#scheduleTerminalNo_input').textbox('getValue'));

        $.getJSON("../json/task/taskState.json",function(result){
            for(let i in result){
                if(handleNullInfo(result[i].text) === state){
                    state = parseInt(result[i].id);
                }
            }

            let reqDate = {
                taskId:parseInt(currTaskID),
                pageIndex:pageIndex,
                pageSize:pageSize,
                companyCode:componayCode,
                storeId:storeId,
                posType:posType,
                taskState:state,
                posId:posId
            };

            console.log(reqDate);
            console.log(123);


            jQuery.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: "http://115.159.142.32:20002/taskpos",
                type: 'POST',
                contentType:"application/json",
                data: JSON.stringify(reqDate),
                success: function (res) {
                    console.log(res);
                    if(res.status_code === 100){
                        let listData = res.data.rows;
                        let listDatas = new Array();
                        for ( let i=0;i<listData.length;i++) {
                            let rowData =  {
                                'terminalNo' : listData[i].PosID,
                                'terminalType':listData[i].Type,
                                'partionCompanies' : listData[i].CompanyName,
                                'stores' : listData[i].StoreName,
                                'np6' : listData[i].Np6Version,
                                'np6App' : listData[i].Np6ExeVersion,
                                'sokPic' : listData[i].SOKPicVer,
                                'ownSoftware' : listData[i].SelfSoft,
                                'keyPos' : listData[i].ForkVersion
                                //'failLog':""
                            };
                            listDatas.push(rowData);
                        }
                        listDatas.sort(function(a,b) {
                            if(a.terminalNo< b.terminalNo)
                                return -1;
                            else if(a.terminalNo> b.terminalNo){
                                return 1;
                            }
                            else{
                                return 0;
                            }
                        });
                        let p = $('#schedule_list_data').datagrid('getPager');
                        $(p).pagination({
                            displayMsg: '共 '+res.data.total+' 条记录'
                        });
                        $('#schedule_list_data').datagrid('loadData',listDatas);

                    }
                    else{
                        alert(res.msg);
                    }
                },
                error: function (res) {
                    //console.log(res);
                }
            });
        });




    }


    $.parser.onComplete = function(){
        //sch_searchTerminal();
        $.getJSON("../json/task/taskState.json",function(result){
            for(let i in result){
                if(result[i].id!==-2){
                    $('#resultTabs').tabs('add', {
                        title: result[i].text,
                        closable: false
                    });
                }
            }
            $('#resultTabs').tabs('select', '待执行');
        });

        let count = 0;

        $('#resultTabs').tabs({
            onSelect:function(title,index){
                if(title !== '执行失败'){
                    $("#schedule_list_data").datagrid('hideColumn', 'failLog');
                }
                else{
                    $("#schedule_list_data").datagrid('showColumn', 'failLog');
                }
                if(count >= 4){
                    sch_searchTerminal();
                }
                else{
                   count++;
                }

            }
        });
    };

</script>


